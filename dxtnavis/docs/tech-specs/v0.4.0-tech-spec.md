# ê¸°ìˆ  ì„¤ê³„ì„œ: DXTnavis v0.4.0 Feature Expansion

## ë¬¸ì„œ ì •ë³´
| í•­ëª© | ë‚´ìš© |
|------|------|
| ë²„ì „ | v1.0 |
| ì‘ì„±ì¼ | 2026-01-08 |
| PRD ì°¸ì¡° | [v0.4.0-feature-expansion-prd.md](../prd/v0.4.0-feature-expansion-prd.md) |

---

## 1. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### 1.1 v0.4.0 ë³€ê²½ ë²”ìœ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DXTnavis v0.4.0 ë³€ê²½ ì˜ì—­                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Views     â”‚  â”‚  ViewModels â”‚  â”‚       Services          â”‚  â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                         â”‚  â”‚
â”‚  â”‚ [ë³€ê²½]      â”‚  â”‚ [ë³€ê²½]      â”‚  â”‚ [ë³€ê²½/ì‹ ê·œ]             â”‚  â”‚
â”‚  â”‚ DXwindow    â”‚  â”‚ DXwindow    â”‚  â”‚ PropertyFileWriter      â”‚  â”‚
â”‚  â”‚  .xaml      â”‚  â”‚  ViewModel  â”‚  â”‚ SnapshotService         â”‚  â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚ SearchService (ì‹ ê·œ)    â”‚  â”‚
â”‚  â”‚ [ì‹ ê·œ]      â”‚  â”‚             â”‚  â”‚ ViewPointService (ì‹ ê·œ) â”‚  â”‚
â”‚  â”‚ SearchBox   â”‚  â”‚             â”‚  â”‚                         â”‚  â”‚
â”‚  â”‚ LevelCtrl   â”‚  â”‚             â”‚  â”‚                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ëª¨ë“ˆ ì˜ì¡´ì„±

```
DXwindow.xaml
    â”‚
    â–¼
DXwindowViewModel.cs
    â”‚
    â”œâ”€â”€â–º NavisworksSelectionService.cs (ê¸°ì¡´)
    â”œâ”€â”€â–º PropertyFileWriter.cs (ë³€ê²½)
    â”œâ”€â”€â–º HierarchyFileWriter.cs (ê¸°ì¡´)
    â”œâ”€â”€â–º SnapshotService.cs (ë³€ê²½)
    â”œâ”€â”€â–º SearchService.cs (ì‹ ê·œ)
    â””â”€â”€â–º ViewPointService.cs (ì‹ ê·œ)
```

---

## 2. Phase 1: Bug Fixes

### 2.1 ê²€ìƒ‰ì°½ ì˜ì–´ ì…ë ¥ ë¬¸ì œ í•´ê²°

**ë¬¸ì œ ì›ì¸ ë¶„ì„:**
1. WPF TextBoxì˜ IME ì²˜ë¦¬ ì´ìŠˆ
2. PreviewKeyDown ì´ë²¤íŠ¸ì—ì„œ ì˜ë¬¸ í‚¤ ì…ë ¥ ì°¨ë‹¨
3. InputMethod ì„¤ì • ë¬¸ì œ

**í•´ê²° ë°©ë²•:**

```csharp
// DXwindow.xaml
<TextBox x:Name="SearchTextBox"
         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
         InputMethod.IsInputMethodEnabled="True"
         InputMethod.PreferredImeState="On">
    <!-- IME ì„¤ì • ëª…ì‹œ -->
</TextBox>
```

```csharp
// DXwindow.xaml.cs - ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ê²€í† 
private void SearchTextBox_PreviewKeyDown(object sender, KeyEventArgs e)
{
    // ì˜ì–´ í‚¤ ì°¨ë‹¨ ë¡œì§ì´ ìˆë‹¤ë©´ ì œê±°
    // íŠ¹ìˆ˜ í‚¤(Enter, Escape)ë§Œ ì²˜ë¦¬
    if (e.Key == Key.Enter)
    {
        // ê²€ìƒ‰ ì‹¤í–‰
        e.Handled = true;
    }
    else if (e.Key == Key.Escape)
    {
        // ê²€ìƒ‰ì°½ ë‹«ê¸°
        e.Handled = true;
    }
    // ë‹¤ë¥¸ í‚¤ëŠ” ê¸°ë³¸ ì²˜ë¦¬ (e.Handled = false)
}
```

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤:**
- [ ] ì˜ì–´ ì•ŒíŒŒë²³ ì…ë ¥ (a-z, A-Z)
- [ ] ìˆ«ì ì…ë ¥ (0-9)
- [ ] íŠ¹ìˆ˜ë¬¸ì ì…ë ¥ (!@#$%^&*)
- [ ] í•œê¸€ ì…ë ¥ (ê°€-í£)
- [ ] IME ì „í™˜ (í•œ/ì˜)
- [ ] í˜¼í•© ì…ë ¥ (í•œì˜ ì„ì„)

### 2.2 ViewPoint ì €ì¥ Read-Only ì˜¤ë¥˜ í•´ê²°

**ë¬¸ì œ ì›ì¸ ë¶„ì„:**
1. Document.SavedViewpointsê°€ Read-Only ì»¬ë ‰ì…˜
2. ComAPIë¥¼ í†µí•œ ì ‘ê·¼ í•„ìš”
3. Document ìƒíƒœ í™•ì¸ ë¯¸í¡

**í•´ê²° ë°©ë²•:**

```csharp
// SnapshotService.cs
using Autodesk.Navisworks.Api.Interop.ComApi;
using Autodesk.Navisworks.Api.ComApi;

public class ViewPointService
{
    /// <summary>
    /// ComAPIë¥¼ í†µí•œ ViewPoint ì €ì¥
    /// </summary>
    public bool SaveViewPoint(string viewpointName)
    {
        try
        {
            // ComAPI ì ‘ê·¼
            var comState = ComApiBridge.State;
            var comDoc = comState as InwOpState;

            if (comDoc == null)
            {
                Logger.Error("ComAPI ì´ˆê¸°í™” ì‹¤íŒ¨");
                return false;
            }

            // í˜„ì¬ ë·° ê°€ì ¸ì˜¤ê¸°
            var currentView = comDoc.CurrentView;

            // SavedViewpoints í´ë” ì ‘ê·¼
            var savedViews = comDoc.SavedViews();

            // ViewPoint ìƒì„± ë° ì €ì¥
            var viewpoint = savedViews.CreateSavedViewpointCopy(currentView);
            viewpoint.name = viewpointName;
            savedViews.Add(viewpoint);

            Logger.Info($"ViewPoint ì €ì¥ ì„±ê³µ: {viewpointName}");
            return true;
        }
        catch (Exception ex)
        {
            Logger.Error($"ViewPoint ì €ì¥ ì‹¤íŒ¨: {ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// Document Read-Only ìƒíƒœ í™•ì¸
    /// </summary>
    private bool IsDocumentEditable()
    {
        var doc = Application.ActiveDocument;
        return doc != null && !doc.IsCleared;
    }
}
```

**ComAPI ì´ˆê¸°í™” íŒ¨í„´:**

```csharp
// ComAPI ë¸Œë¦¿ì§€ ì´ˆê¸°í™”
public static class ComApiBridge
{
    private static object _state;

    public static object State
    {
        get
        {
            if (_state == null)
            {
                var doc = Application.ActiveDocument;
                if (doc != null)
                {
                    // ComApi ë¸Œë¦¿ì§€ë¥¼ í†µí•œ ìƒíƒœ ì ‘ê·¼
                    _state = ComApiBridge.GetComAPI(doc);
                }
            }
            return _state;
        }
    }
}
```

---

## 3. Phase 2: Tree Enhancement

### 3.1 ë ˆë²¨ë³„ Expand/Collapse êµ¬í˜„

**UI ì„¤ê³„:**

```xml
<!-- DXwindow.xaml - Level Control Panel -->
<StackPanel Orientation="Horizontal" Margin="5">
    <TextBlock Text="Level:" VerticalAlignment="Center" Margin="0,0,5,0"/>

    <!-- Level Buttons (L0 ~ L10) -->
    <ItemsControl ItemsSource="{Binding LevelButtons}">
        <ItemsControl.ItemsPanel>
            <ItemsPanelTemplate>
                <StackPanel Orientation="Horizontal"/>
            </ItemsPanelTemplate>
        </ItemsControl.ItemsPanel>
        <ItemsControl.ItemTemplate>
            <DataTemplate>
                <ToggleButton Width="25" Height="25"
                              Content="{Binding Level}"
                              IsChecked="{Binding IsExpanded}"
                              Command="{Binding DataContext.ToggleLevelCommand,
                                        RelativeSource={RelativeSource AncestorType=Window}}"
                              CommandParameter="{Binding Level}"
                              ToolTip="Click to expand/collapse to this level"/>
            </DataTemplate>
        </ItemsControl.ItemTemplate>
    </ItemsControl>

    <!-- Expand All / Collapse All -->
    <Button Content="â–¼" Width="30" Margin="10,0,0,0"
            Command="{Binding ExpandAllCommand}" ToolTip="Expand All"/>
    <Button Content="â–²" Width="30" Margin="2,0,0,0"
            Command="{Binding CollapseAllCommand}" ToolTip="Collapse All"/>
</StackPanel>
```

**ViewModel êµ¬í˜„:**

```csharp
// DXwindowViewModel.cs

/// <summary>
/// íŠ¹ì • ë ˆë²¨ê¹Œì§€ í™•ì¥
/// </summary>
public void ExpandToLevel(int targetLevel)
{
    foreach (var node in GetAllNodes(HierarchyItems))
    {
        if (node.Level <= targetLevel)
        {
            node.IsExpanded = true;
        }
        else
        {
            node.IsExpanded = false;
        }
    }
    OnPropertyChanged(nameof(HierarchyItems));
}

/// <summary>
/// íŠ¹ì • ë ˆë²¨ë¶€í„° ì¶•ì†Œ
/// </summary>
public void CollapseFromLevel(int targetLevel)
{
    foreach (var node in GetAllNodes(HierarchyItems))
    {
        if (node.Level >= targetLevel)
        {
            node.IsExpanded = false;
        }
    }
    OnPropertyChanged(nameof(HierarchyItems));
}

/// <summary>
/// ë ˆë²¨ í† ê¸€ (expand if collapsed, collapse if expanded)
/// </summary>
public void ToggleLevel(int level)
{
    var nodesAtLevel = GetNodesAtLevel(HierarchyItems, level);
    bool anyExpanded = nodesAtLevel.Any(n => n.IsExpanded);

    if (anyExpanded)
    {
        CollapseFromLevel(level);
    }
    else
    {
        ExpandToLevel(level);
    }
}

/// <summary>
/// ëª¨ë“  ë…¸ë“œ ê°€ì ¸ì˜¤ê¸° (ì¬ê·€)
/// </summary>
private IEnumerable<HierarchyNodeViewModel> GetAllNodes(
    ObservableCollection<HierarchyNodeViewModel> nodes)
{
    foreach (var node in nodes)
    {
        yield return node;
        foreach (var child in GetAllNodes(node.Children))
        {
            yield return child;
        }
    }
}

/// <summary>
/// íŠ¹ì • ë ˆë²¨ì˜ ë…¸ë“œë§Œ ê°€ì ¸ì˜¤ê¸°
/// </summary>
private IEnumerable<HierarchyNodeViewModel> GetNodesAtLevel(
    ObservableCollection<HierarchyNodeViewModel> nodes, int level)
{
    return GetAllNodes(nodes).Where(n => n.Level == level);
}
```

### 3.2 Level Button ViewModel

```csharp
// LevelButtonViewModel.cs
public class LevelButtonViewModel : INotifyPropertyChanged
{
    public int Level { get; set; }

    private bool _isExpanded;
    public bool IsExpanded
    {
        get => _isExpanded;
        set
        {
            _isExpanded = value;
            OnPropertyChanged();
        }
    }

    public string DisplayText => Level == 10 ? "A" : Level.ToString();
}
```

---

## 4. Phase 3: ViewPoint & Navigation

### 4.1 Home ViewPoint ê´€ë¦¬

```csharp
// ViewPointService.cs
public class ViewPointService
{
    private const string HOME_VIEWPOINT_NAME = "__DXTnavis_Home__";

    /// <summary>
    /// í”ŒëŸ¬ê·¸ì¸ ë¡œë“œ ì‹œ Home ViewPoint ì €ì¥
    /// </summary>
    public void InitializeHomeViewPoint()
    {
        if (!HasHomeViewPoint())
        {
            SaveHomeViewPoint();
        }
    }

    /// <summary>
    /// Home ViewPoint ì¡´ì¬ í™•ì¸
    /// </summary>
    public bool HasHomeViewPoint()
    {
        var doc = Application.ActiveDocument;
        return doc.SavedViewpoints.Any(v => v.DisplayName == HOME_VIEWPOINT_NAME);
    }

    /// <summary>
    /// Home ViewPoint ì €ì¥
    /// </summary>
    public void SaveHomeViewPoint()
    {
        SaveViewPoint(HOME_VIEWPOINT_NAME);
    }

    /// <summary>
    /// Home ViewPointë¡œ ë³µì›
    /// </summary>
    public void ResetToHome()
    {
        var doc = Application.ActiveDocument;
        var homeViewpoint = doc.SavedViewpoints
            .FirstOrDefault(v => v.DisplayName == HOME_VIEWPOINT_NAME);

        if (homeViewpoint != null)
        {
            doc.ActiveView.CopyFrom(homeViewpoint.Viewpoint);
            Logger.Info("Home ViewPointë¡œ ë³µì›ë¨");
        }
        else
        {
            Logger.Warn("Home ViewPointê°€ ì—†ìŒ. ë¨¼ì € ì €ì¥ í•„ìš”");
        }
    }
}
```

### 4.2 Object ê²€ìƒ‰ ê¸°ëŠ¥

```csharp
// SearchService.cs
public class SearchService
{
    public enum SearchMode
    {
        ByName,
        ByProperty
    }

    /// <summary>
    /// ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰
    /// </summary>
    public List<ModelItem> SearchByName(string query, bool caseSensitive = false)
    {
        var doc = Application.ActiveDocument;
        var results = new List<ModelItem>();

        var comparison = caseSensitive
            ? StringComparison.Ordinal
            : StringComparison.OrdinalIgnoreCase;

        foreach (var item in doc.Models.RootItems.DescendantsAndSelf)
        {
            if (item.DisplayName?.IndexOf(query, comparison) >= 0)
            {
                results.Add(item);
            }
        }

        return results;
    }

    /// <summary>
    /// ì†ì„± ê°’ìœ¼ë¡œ ê²€ìƒ‰
    /// </summary>
    public List<ModelItem> SearchByProperty(
        string categoryName,
        string propertyName,
        string value)
    {
        var doc = Application.ActiveDocument;
        var results = new List<ModelItem>();

        foreach (var item in doc.Models.RootItems.DescendantsAndSelf)
        {
            foreach (var category in item.PropertyCategories)
            {
                if (!string.IsNullOrEmpty(categoryName) &&
                    category.DisplayName != categoryName)
                    continue;

                foreach (var property in category.Properties)
                {
                    if (!string.IsNullOrEmpty(propertyName) &&
                        property.DisplayName != propertyName)
                        continue;

                    var propValue = property.Value?.ToDisplayString() ?? "";
                    if (propValue.Contains(value))
                    {
                        results.Add(item);
                        break;
                    }
                }
            }
        }

        return results;
    }

    /// <summary>
    /// ê²€ìƒ‰ ê²°ê³¼ë¥¼ 3Dì—ì„œ ì„ íƒ
    /// </summary>
    public void SelectSearchResults(List<ModelItem> results)
    {
        var doc = Application.ActiveDocument;
        doc.CurrentSelection.Clear();
        doc.CurrentSelection.AddRange(results);
    }

    /// <summary>
    /// ê²€ìƒ‰ ê²°ê³¼ë¥¼ 3Dì—ì„œ í•˜ì´ë¼ì´íŠ¸
    /// </summary>
    public void HighlightSearchResults(List<ModelItem> results)
    {
        SelectSearchResults(results);

        // ì²« ë²ˆì§¸ ê²°ê³¼ë¡œ ì¤Œ
        if (results.Any())
        {
            doc.ActiveView.ZoomToSelection();
        }
    }
}
```

---

## 5. Phase 4: CSV Export Enhancement

### 5.1 Selection Properties ì¶œë ¥

```csharp
// PropertyFileWriter.cs
public class PropertyFileWriter
{
    /// <summary>
    /// ì„ íƒëœ ê°ì²´ë“¤ì˜ ì†ì„±ë§Œ ì¶œë ¥
    /// </summary>
    public void ExportSelectionProperties(string outputPath)
    {
        var doc = Application.ActiveDocument;
        var selectedItems = doc.CurrentSelection.SelectedItems;

        if (!selectedItems.Any())
        {
            Logger.Warn("ì„ íƒëœ ê°ì²´ê°€ ì—†ìŒ");
            return;
        }

        ExportProperties(outputPath, selectedItems.ToList());
    }

    /// <summary>
    /// ì „ì²´ ì†ì„± ì¶œë ¥
    /// </summary>
    public void ExportAllProperties(string outputPath)
    {
        var doc = Application.ActiveDocument;
        var allItems = doc.Models.RootItems.DescendantsAndSelf.ToList();

        ExportProperties(outputPath, allItems);
    }

    /// <summary>
    /// ê³µí†µ ì†ì„± ì¶œë ¥ ë¡œì§
    /// </summary>
    private void ExportProperties(string outputPath, List<ModelItem> items)
    {
        using (var writer = new StreamWriter(outputPath, false, Encoding.UTF8))
        {
            // í—¤ë” ì‘ì„±
            writer.WriteLine("ObjectId,DisplayName,Category,Property,Value");

            foreach (var item in items)
            {
                var objectId = GetObjectId(item);
                var displayName = item.DisplayName ?? "";

                foreach (var category in item.PropertyCategories)
                {
                    foreach (var property in category.Properties)
                    {
                        var value = property.Value?.ToDisplayString() ?? "";
                        writer.WriteLine($"\"{objectId}\",\"{displayName}\",\"{category.DisplayName}\",\"{property.DisplayName}\",\"{value}\"");
                    }
                }
            }
        }

        Logger.Info($"Properties ì¶œë ¥ ì™„ë£Œ: {items.Count}ê°œ ê°ì²´ â†’ {outputPath}");
    }
}
```

### 5.2 DisplayString íŒŒì‹± (Refined CSV)

```csharp
// DisplayStringParser.cs
public static class DisplayStringParser
{
    // DisplayString:123.45 m^2 í˜•ì‹ íŒŒì‹±
    private static readonly Regex DisplayStringPattern =
        new Regex(@"^DisplayString:(-?\d+\.?\d*(?:[eE][+-]?\d+)?)\s*(.*)$",
                  RegexOptions.Compiled);

    /// <summary>
    /// DisplayString ê°’ íŒŒì‹±
    /// </summary>
    public static (string raw, string value, string unit) Parse(string displayString)
    {
        if (string.IsNullOrEmpty(displayString))
            return (displayString, "", "");

        var match = DisplayStringPattern.Match(displayString);
        if (match.Success)
        {
            var numericValue = match.Groups[1].Value;
            var unit = match.Groups[2].Value.Trim();
            var raw = displayString.Replace("DisplayString:", "").Trim();

            return (raw, numericValue, unit);
        }

        // íŒ¨í„´ ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
        return (displayString, displayString, "");
    }
}

// PropertyFileWriter.cs - Refined CSV ì¶œë ¥
public class PropertyFileWriter
{
    /// <summary>
    /// Refined CSV ì¶œë ¥ (DisplayString íŒŒì‹± ì ìš©)
    /// </summary>
    public void ExportRefinedProperties(string outputPath, List<ModelItem> items)
    {
        using (var writer = new StreamWriter(outputPath, false, Encoding.UTF8))
        {
            // Refined í—¤ë”
            writer.WriteLine("ObjectId,DisplayName,Category,Property,DisplayString,Value,Unit");

            foreach (var item in items)
            {
                var objectId = GetObjectId(item);
                var displayName = EscapeCsv(item.DisplayName ?? "");

                foreach (var category in item.PropertyCategories)
                {
                    foreach (var property in category.Properties)
                    {
                        var rawValue = property.Value?.ToDisplayString() ?? "";
                        var (displayStr, value, unit) = DisplayStringParser.Parse(rawValue);

                        writer.WriteLine(
                            $"\"{objectId}\"," +
                            $"\"{displayName}\"," +
                            $"\"{EscapeCsv(category.DisplayName)}\"," +
                            $"\"{EscapeCsv(property.DisplayName)}\"," +
                            $"\"{EscapeCsv(displayStr)}\"," +
                            $"\"{EscapeCsv(value)}\"," +
                            $"\"{EscapeCsv(unit)}\"");
                    }
                }
            }
        }
    }

    /// <summary>
    /// Raw/Refined ë™ì‹œ ì¶œë ¥
    /// </summary>
    public void ExportBothFormats(string basePath, List<ModelItem> items)
    {
        var rawPath = Path.Combine(
            Path.GetDirectoryName(basePath),
            Path.GetFileNameWithoutExtension(basePath) + "_raw.csv");

        var refinedPath = Path.Combine(
            Path.GetDirectoryName(basePath),
            Path.GetFileNameWithoutExtension(basePath) + "_refined.csv");

        ExportProperties(rawPath, items);
        ExportRefinedProperties(refinedPath, items);

        Logger.Info($"Raw/Refined CSV ë™ì‹œ ì¶œë ¥ ì™„ë£Œ");
    }

    private string EscapeCsv(string value)
    {
        if (value.Contains("\"") || value.Contains(",") || value.Contains("\n"))
        {
            return value.Replace("\"", "\"\"");
        }
        return value;
    }
}
```

### 5.3 CSV ì¶œë ¥ UI ë§¤íŠ¸ë¦­ìŠ¤

```xml
<!-- DXwindow.xaml - CSV Export Panel -->
<GroupBox Header="CSV Export" Margin="5">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Row Headers -->
        <TextBlock Grid.Row="1" Grid.Column="0" Text="Properties"
                   VerticalAlignment="Center" Margin="5"/>
        <TextBlock Grid.Row="2" Grid.Column="0" Text="Hierarchy"
                   VerticalAlignment="Center" Margin="5"/>

        <!-- Column Headers -->
        <TextBlock Grid.Row="0" Grid.Column="1" Text="All"
                   HorizontalAlignment="Center" Margin="5"/>
        <TextBlock Grid.Row="0" Grid.Column="2" Text="Selection"
                   HorizontalAlignment="Center" Margin="5"/>

        <!-- Buttons -->
        <Button Grid.Row="1" Grid.Column="1" Content="All Prop"
                Command="{Binding ExportAllPropertiesCommand}" Margin="2"/>
        <Button Grid.Row="1" Grid.Column="2" Content="Sele Prop"
                Command="{Binding ExportSelectionPropertiesCommand}" Margin="2"/>
        <Button Grid.Row="2" Grid.Column="1" Content="All Hier"
                Command="{Binding ExportAllHierarchyCommand}" Margin="2"/>
        <Button Grid.Row="2" Grid.Column="2" Content="Sele Hier"
                Command="{Binding ExportSelectionHierarchyCommand}" Margin="2"/>
    </Grid>

    <!-- Format Options -->
    <StackPanel Orientation="Horizontal" Margin="5,10,5,5">
        <CheckBox Content="Raw CSV" IsChecked="{Binding ExportRawCsv}"/>
        <CheckBox Content="Refined CSV" IsChecked="{Binding ExportRefinedCsv}"
                  Margin="10,0,0,0"/>
    </StackPanel>
</GroupBox>
```

---

## 6. Phase 5: ComAPI Research

### 6.1 ì¡°ì‚¬ í•­ëª©

| í•­ëª© | ì¡°ì‚¬ ë‚´ìš© | ìƒíƒœ |
|------|----------|------|
| Property Read-Only | API ìˆ˜ì¤€ ì œì•½ í™•ì¸ | ğŸ“‹ ì˜ˆì • |
| ComAPI InwOpState | ObjectProps ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ | ğŸ“‹ ì˜ˆì • |
| User Data | InwUserData í™œìš© ê°€ëŠ¥ ì—¬ë¶€ | ğŸ“‹ ì˜ˆì • |
| Custom Properties | ì‚¬ìš©ì ì •ì˜ ì†ì„± íƒ­ ìƒì„± | ğŸ“‹ ì˜ˆì • |

### 6.2 POC ì½”ë“œ (ì¡°ì‚¬ìš©)

```csharp
// ComApiResearch.cs - POC ì½”ë“œ
public class ComApiResearch
{
    /// <summary>
    /// ComAPIë¥¼ í†µí•œ Property ì ‘ê·¼ í…ŒìŠ¤íŠ¸
    /// </summary>
    public void TestPropertyAccess()
    {
        var comState = ComApiBridge.State as InwOpState;
        if (comState == null) return;

        // ì„ íƒëœ ê°ì²´ì˜ ì†ì„± ì ‘ê·¼
        var selection = comState.CurrentSelection;
        foreach (InwOaPath path in selection.Paths())
        {
            var properties = path.Properties();
            foreach (InwOaProperty prop in properties)
            {
                Console.WriteLine($"Property: {prop.name}, Value: {prop.value}");

                // Write í…ŒìŠ¤íŠ¸ (ì˜ˆìƒ: ì‹¤íŒ¨)
                try
                {
                    prop.value = "Test Value";
                    Console.WriteLine("Write ì„±ê³µ!");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Write ì‹¤íŒ¨: {ex.Message}");
                }
            }
        }
    }

    /// <summary>
    /// User Data í™œìš© í…ŒìŠ¤íŠ¸
    /// </summary>
    public void TestUserData()
    {
        var comState = ComApiBridge.State as InwOpState;
        if (comState == null) return;

        // User Data ì ‘ê·¼
        var userData = comState.UserData;

        // Custom ë°ì´í„° ì €ì¥ ì‹œë„
        try
        {
            // userDataì— ì»¤ìŠ¤í…€ ì†ì„± ì¶”ê°€ ê°€ëŠ¥ ì—¬ë¶€ í…ŒìŠ¤íŠ¸
            Console.WriteLine("User Data ì ‘ê·¼ ê°€ëŠ¥");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"User Data ì ‘ê·¼ ì‹¤íŒ¨: {ex.Message}");
        }
    }
}
```

---

## 7. ìŠ¤ë ˆë“œ ì•ˆì „ì„±

### 7.1 UI Thread ì¤€ìˆ˜ íŒ¨í„´

```csharp
// ThreadSafetyHelper.cs
public static class ThreadSafetyHelper
{
    /// <summary>
    /// UI ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ ë³´ì¥
    /// </summary>
    public static void ExecuteOnUIThread(Action action)
    {
        if (Application.Current?.Dispatcher == null)
        {
            action();
            return;
        }

        if (Application.Current.Dispatcher.CheckAccess())
        {
            action();
        }
        else
        {
            Application.Current.Dispatcher.Invoke(action);
        }
    }

    /// <summary>
    /// UI ìŠ¤ë ˆë“œì—ì„œ ë¹„ë™ê¸° ì‹¤í–‰
    /// </summary>
    public static async Task ExecuteOnUIThreadAsync(Func<Task> asyncAction)
    {
        if (Application.Current?.Dispatcher == null)
        {
            await asyncAction();
            return;
        }

        await Application.Current.Dispatcher.InvokeAsync(asyncAction);
    }
}
```

### 7.2 Navisworks API í˜¸ì¶œ íŒ¨í„´

```csharp
// ì˜¬ë°”ë¥¸ íŒ¨í„´
ThreadSafetyHelper.ExecuteOnUIThread(() =>
{
    var doc = Application.ActiveDocument;
    doc.CurrentSelection.Clear();
    doc.CurrentSelection.Add(item);
});

// ì˜ëª»ëœ íŒ¨í„´ (âŒ)
Task.Run(() =>
{
    var doc = Application.ActiveDocument; // ì˜¤ë¥˜ ë°œìƒ!
});
```

---

## 8. ì—ëŸ¬ ì²˜ë¦¬

### 8.1 ì˜ˆì™¸ ì²˜ë¦¬ ì „ëµ

| ì˜ˆì™¸ ìœ í˜• | ì²˜ë¦¬ ë°©ë²• |
|----------|----------|
| ComApi Exception | ë¡œê¹… í›„ ëŒ€ì²´ ë°©ë²• ì‹œë„ |
| InvalidOperationException | ì‚¬ìš©ì ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ |
| NullReferenceException | ë°©ì–´ì  null ì²´í¬ |
| IOException | íŒŒì¼ ê²½ë¡œ ë³€ê²½ ìš”ì²­ |

### 8.2 ë¡œê¹… íŒ¨í„´

```csharp
// Logger.cs
public static class Logger
{
    public static void Info(string message) => Log("INFO", message);
    public static void Warn(string message) => Log("WARN", message);
    public static void Error(string message) => Log("ERROR", message);

    private static void Log(string level, string message)
    {
        var timestamp = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
        var logMessage = $"[{timestamp}] [{level}] {message}";

        // ì½˜ì†” ì¶œë ¥
        Debug.WriteLine(logMessage);

        // íŒŒì¼ ì¶œë ¥ (Verbose ëª¨ë“œ)
        if (IsVerboseMode)
        {
            AppendToLogFile(logMessage);
        }
    }
}
```

---

## 9. í…ŒìŠ¤íŠ¸ ê³„íš

| í…ŒìŠ¤íŠ¸ ìœ í˜• | ëŒ€ìƒ | ê¸°ì¤€ |
|------------|------|------|
| ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ | DisplayStringParser | íŒŒì‹± ì •í™•ë„ 100% |
| ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ | SearchService | ê²€ìƒ‰ ê²°ê³¼ ì •í™•ë„ |
| í†µí•© í…ŒìŠ¤íŠ¸ | CSV Export 4ì¢… | ì •ìƒ ì¶œë ¥ |
| UI í…ŒìŠ¤íŠ¸ | Level Expand/Collapse | ë™ì‘ í™•ì¸ |
| íšŒê·€ í…ŒìŠ¤íŠ¸ | ê²€ìƒ‰ì°½ ì…ë ¥ | í•œì˜ ì…ë ¥ ì •ìƒ |

---

## 10. íŒŒì¼ ë³€ê²½ ëª©ë¡

### 10.1 ìˆ˜ì • íŒŒì¼

| íŒŒì¼ | ë³€ê²½ ë‚´ìš© |
|------|----------|
| DXwindow.xaml | ê²€ìƒ‰ UI, Level ì»¨íŠ¸ë¡¤, CSV ë²„íŠ¼ ì¶”ê°€ |
| DXwindowViewModel.cs | Level í† ê¸€, ê²€ìƒ‰, CSV ì»¤ë§¨ë“œ ì¶”ê°€ |
| PropertyFileWriter.cs | Selection ì¶œë ¥, Refined CSV ì¶”ê°€ |
| SnapshotService.cs | ViewPoint ì €ì¥ ë¡œì§ ìˆ˜ì • |

### 10.2 ì‹ ê·œ íŒŒì¼

| íŒŒì¼ | ìš©ë„ |
|------|------|
| SearchService.cs | ê°ì²´ ê²€ìƒ‰ ì„œë¹„ìŠ¤ |
| ViewPointService.cs | ViewPoint ê´€ë¦¬ ì„œë¹„ìŠ¤ |
| DisplayStringParser.cs | DisplayString íŒŒì‹± ìœ í‹¸ë¦¬í‹° |
| ThreadSafetyHelper.cs | ìŠ¤ë ˆë“œ ì•ˆì „ì„± í—¬í¼ |
| ComApiResearch.cs | ComAPI ì—°êµ¬ POC |

---

## 11. ì°¸ì¡°

- [PRD v0.4.0](../prd/v0.4.0-feature-expansion-prd.md)
- [Sprint v0.4.0](../agile/SPRINT-v0.4.0.md)
- [CLAUDE.md](../../CLAUDE.md)
- [Navisworks API Guide](https://help.autodesk.com/view/NAV/2025/ENU/)

---

**Created**: 2026-01-08
**Last Updated**: 2026-01-08
